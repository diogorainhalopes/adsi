<!doctype html><html lang=en><head><meta charset=utf-8><meta name=description content="Slides
Database Crash and Recovery System Failure Classification Transaction failure  Logical errors  &ldquo;not enough money to transfer&rdquo; transaction cannot complete due to some internal error condition   System errors  the database system must terminate an active transaction due to an error condition ( e."><meta property="og:title" content="Lecture 8 - Database Recovery"><meta property="og:description" content="Slides
Database Crash and Recovery System Failure Classification Transaction failure  Logical errors  &ldquo;not enough money to transfer&rdquo; transaction cannot complete due to some internal error condition   System errors  the database system must terminate an active transaction due to an error condition ( e."><meta property="og:type" content="website"><meta property="og:image" content="https://diogorainhalopes.github.io/quartz/icon.png"><meta property="og:url" content="https://diogorainhalopes.github.io/quartz/Lectures/Lecture-8-Database-Recovery/"><meta property="og:width" content="200"><meta property="og:height" content="200"><meta name=twitter:card content="summary"><meta name=twitter:title content="Lecture 8 - Database Recovery"><meta name=twitter:description content="Slides
Database Crash and Recovery System Failure Classification Transaction failure  Logical errors  &ldquo;not enough money to transfer&rdquo; transaction cannot complete due to some internal error condition   System errors  the database system must terminate an active transaction due to an error condition ( e."><meta name=twitter:image content="https://diogorainhalopes.github.io/quartz/icon.png"><title>Lecture 8 - Database Recovery</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" type=image/png href=https://diogorainhalopes.github.io/quartz//icon.png><link href=https://diogorainhalopes.github.io/quartz/styles.b369a84b3c6e6bfd686ad1f9da65641c.min.css rel=stylesheet><link href=https://diogorainhalopes.github.io/quartz/styles/_light_syntax.86a48a52faebeaaf42158b72922b1c90.min.css rel=stylesheet id=theme-link><script src=https://diogorainhalopes.github.io/quartz/js/darkmode.761b8f1dfa0dcf0ccf9c35c81fa0d07d.min.js></script>
<script src=https://diogorainhalopes.github.io/quartz/js/util.a0ccf91e1937fe761a74da4946452710.min.js></script>
<link rel=preload href=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css as=style onload='this.onload=null,this.rel="stylesheet"' integrity=sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js integrity=sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.2/dist/contrib/copy-tex.min.js integrity=sha384-ww/583aHhxWkz5DEVn6OKtNiIaLi2iBRNZXfJRiY1Ai7tnJ9UXpEsyvOITVpTl4A crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/@floating-ui/core@1.2.1></script>
<script src=https://cdn.jsdelivr.net/npm/@floating-ui/dom@1.2.1></script>
<script async src=https://diogorainhalopes.github.io/quartz/js/popover.aa9bc99c7c38d3ae9538f218f1416adb.min.js></script>
<script defer src=https://diogorainhalopes.github.io/quartz/js/code-title.ce4a43f09239a9efb48fee342e8ef2df.min.js></script>
<script defer src=https://diogorainhalopes.github.io/quartz/js/clipboard.2913da76d3cb21c5deaa4bae7da38c9f.min.js></script>
<script defer src=https://diogorainhalopes.github.io/quartz/js/callouts.7723cac461d613d118ee8bb8216b9838.min.js></script>
<script>const SEARCH_ENABLED=!1,LATEX_ENABLED=!0,PRODUCTION=!0,BASE_URL="https://diogorainhalopes.github.io/quartz/",fetchData=Promise.all([fetch("https://diogorainhalopes.github.io/quartz/indices/linkIndex.94f8786fc63ebe8e05322571a173a75f.min.json").then(e=>e.json()).then(e=>({index:e.index,links:e.links})),fetch("https://diogorainhalopes.github.io/quartz/indices/contentIndex.4d8a0702bfaf0dc9c4b89927d55031d6.min.json").then(e=>e.json())]).then(([{index:e,links:t},n])=>({index:e,links:t,content:n})),render=()=>{const e=new URL(BASE_URL),t=e.pathname,n=window.location.pathname,s=t==n;addCopyButtons(),addTitleToCodeBlocks(),addCollapsibleCallouts(),initPopover("https://diogorainhalopes.github.io/quartz",!0);const o=document.getElementById("footer");if(o){const e=document.getElementById("graph-container");if(!e)return requestAnimationFrame(render);e.textContent="";const t=s&&!0;drawGraph("https://diogorainhalopes.github.io/quartz",t,[{"/moc":"#4388cc"}],t?{centerForce:1,depth:2,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.5,linkDistance:1,opacityScale:3,repelForce:1,scale:1.4}:{centerForce:1,depth:2,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.6,linkDistance:1,opacityScale:3,repelForce:2,scale:1.2})}function i(n){const e=n.target,t=e.className.split(" "),s=t.includes("broken"),o=t.includes("internal-link");plausible("Link Click",{props:{href:e.href,broken:s,internal:o,graph:!1}})}const a=document.querySelectorAll("a");for(link of a)link.className.includes("root-title")&&link.addEventListener("click",i,{once:!0})},init=(e=document)=>{addCopyButtons(),addTitleToCodeBlocks(),renderMathInElement(e.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],macros:{'’':"'"},throwOnError:!1})}</script><script type=module>
    import { attachSPARouting } from "https:\/\/diogorainhalopes.github.io\/quartz\/js\/router.d6fe6bd821db9ea97f9aeefae814d8e7.min.js"
    attachSPARouting(init, render)
  </script><script defer data-domain=diogorainhalopes.github.io/quartz src=https://plausible.io/js/script.js></script>
<script>window.plausible=window.plausible||function(){(window.plausible.q=window.plausible.q||[]).push(arguments)}</script></head><body><div id=search-container><div id=search-space><input autocomplete=off id=search-bar name=search type=text aria-label=Search placeholder="Search for something..."><div id=results-container></div></div></div><script src=https://cdn.jsdelivr.net/npm/flexsearch@0.7.21/dist/flexsearch.bundle.js integrity="sha256-i3A0NZGkhsKjVMzFxv3ksk0DZh3aXqu0l49Bbh0MdjE=" crossorigin=anonymous defer></script>
<script defer src=https://diogorainhalopes.github.io/quartz/js/full-text-search.e6e2e0c213187ca0c703d6e2c7a77fcd.min.js></script><div class=singlePage><header><h1 id=page-title><a class=root-title href=https://diogorainhalopes.github.io/quartz/>ADSI Notes - Diogo Lopes</a></h1><div class=spacer></div><div id=search-icon><p>Search</p><svg tabindex="0" aria-labelledby="title desc" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title id="title">Search Icon</title><desc id="desc">Icon to open search</desc><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"/><circle cx="8" cy="8" r="7"/></g></svg></div><div class=darkmode><input class=toggle id=darkmode-toggle type=checkbox tabindex=-1>
<label id=toggle-label-light for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="dayIcon" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35"><title>Light Mode</title><path d="M6 17.5C6 16.672 5.328 16 4.5 16h-3C.672 16 0 16.672.0 17.5S.672 19 1.5 19h3C5.328 19 6 18.328 6 17.5zM7.5 26c-.414.0-.789.168-1.061.439l-2 2C4.168 28.711 4 29.086 4 29.5 4 30.328 4.671 31 5.5 31c.414.0.789-.168 1.06-.44l2-2C8.832 28.289 9 27.914 9 27.5 9 26.672 8.329 26 7.5 26zm10-20C18.329 6 19 5.328 19 4.5v-3C19 .672 18.329.0 17.5.0S16 .672 16 1.5v3C16 5.328 16.671 6 17.5 6zm10 3c.414.0.789-.168 1.06-.439l2-2C30.832 6.289 31 5.914 31 5.5 31 4.672 30.329 4 29.5 4c-.414.0-.789.168-1.061.44l-2 2C26.168 6.711 26 7.086 26 7.5 26 8.328 26.671 9 27.5 9zM6.439 8.561C6.711 8.832 7.086 9 7.5 9 8.328 9 9 8.328 9 7.5c0-.414-.168-.789-.439-1.061l-2-2C6.289 4.168 5.914 4 5.5 4 4.672 4 4 4.672 4 5.5c0 .414.168.789.439 1.06l2 2.001zM33.5 16h-3c-.828.0-1.5.672-1.5 1.5s.672 1.5 1.5 1.5h3c.828.0 1.5-.672 1.5-1.5S34.328 16 33.5 16zM28.561 26.439C28.289 26.168 27.914 26 27.5 26c-.828.0-1.5.672-1.5 1.5.0.414.168.789.439 1.06l2 2C28.711 30.832 29.086 31 29.5 31c.828.0 1.5-.672 1.5-1.5.0-.414-.168-.789-.439-1.061l-2-2zM17.5 29c-.829.0-1.5.672-1.5 1.5v3c0 .828.671 1.5 1.5 1.5s1.5-.672 1.5-1.5v-3C19 29.672 18.329 29 17.5 29zm0-22C11.71 7 7 11.71 7 17.5S11.71 28 17.5 28 28 23.29 28 17.5 23.29 7 17.5 7zm0 18c-4.136.0-7.5-3.364-7.5-7.5s3.364-7.5 7.5-7.5 7.5 3.364 7.5 7.5S21.636 25 17.5 25z"/></svg></label><label id=toggle-label-dark for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="nightIcon" viewBox="0 0 100 100" style="enable-background='new 0 0 100 100'"><title>Dark Mode</title><path d="M96.76 66.458c-.853-.852-2.15-1.064-3.23-.534-6.063 2.991-12.858 4.571-19.655 4.571C62.022 70.495 50.88 65.88 42.5 57.5 29.043 44.043 25.658 23.536 34.076 6.47c.532-1.08.318-2.379-.534-3.23-.851-.852-2.15-1.064-3.23-.534-4.918 2.427-9.375 5.619-13.246 9.491-9.447 9.447-14.65 22.008-14.65 35.369.0 13.36 5.203 25.921 14.65 35.368s22.008 14.65 35.368 14.65c13.361.0 25.921-5.203 35.369-14.65 3.872-3.871 7.064-8.328 9.491-13.246C97.826 68.608 97.611 67.309 96.76 66.458z"/></svg></label></div></header><article><h1>Lecture 8 - Database Recovery</h1><p class=meta>Last updated
Mar 17, 2023</p><ul class=tags></ul><aside class=mainTOC><details open><summary>Table of Contents</summary><nav id=TableOfContents><ol><li><a href=#failure-classification>Failure Classification</a><ol><li><a href=#transaction-failure>Transaction failure</a></li><li><a href=#system-crash>System crash</a></li><li><a href=#disk-failure>Disk failure</a></li></ol></li><li><a href=#stable-storage>Stable Storage</a><ol><li><a href=#crash><em><strong>CRASH</strong></em></a></li></ol></li><li><a href=#checkpoints>Checkpoints</a></li><li><a href=#recovery-algorithm>Recovery Algorithm</a></li><li><a href=#aries>ARIES</a><ol><li><a href=#recovery-in-aries>Recovery in ARIES</a></li></ol></li></ol></nav></details></aside><p><a href=https://diogorainhalopes.github.io/quartz/slides/adsi-07-recovery.pdf rel=noopener>Slides</a></p><a href=#database-crash-and-recovery-system><h1 id=database-crash-and-recovery-system><span class=hanchor arialabel=Anchor># </span>Database Crash and Recovery System</h1></a><a href=#failure-classification><h2 id=failure-classification><span class=hanchor arialabel=Anchor># </span>Failure Classification</h2></a><a href=#transaction-failure><h3 id=transaction-failure><span class=hanchor arialabel=Anchor># </span>Transaction failure</h3></a><ul><li><strong>Logical errors</strong><ul><li>&ldquo;not enough money to transfer&rdquo;</li><li>transaction cannot complete due to some internal error condition</li></ul></li><li><strong>System errors</strong><ul><li>the database system must terminate an active transaction due to an error condition ( e.g. deadlock)</li></ul></li></ul><a href=#system-crash><h3 id=system-crash><span class=hanchor arialabel=Anchor># </span>System crash</h3></a><p>A <strong>power failure</strong> or other hardware or software failure causes the system to crash.</p><ul><li>Non volatile storage is assumed not to be <strong>corrupted</strong> by system crash</li><li>Database systems have numerous integrity checks to prevent corruption of disk data</li></ul><a href=#disk-failure><h3 id=disk-failure><span class=hanchor arialabel=Anchor># </span>Disk failure</h3></a><p>A head crash or similar disk failure destroys <strong>all or part of disk storage</strong></p><ul><li>Destruction is assumed to be <strong>detectable</strong>: disk drives use checksums to detect failures</li></ul><a href=#stable-storage><h2 id=stable-storage><span class=hanchor arialabel=Anchor># </span>Stable Storage</h2></a><p>See: Volatile and Non-Volatile Storage</p><p>An ideal form of storage that survives all failures</p><ul><li>Approximated by maintaining multiple copies on non volatile media</li><li>RAID is not enough; copies should be at different remote sites to protect against disasters such as fire or flooding
Ideally Logs should be stored here in order to replicate in case of some failure</li></ul><p><img src=https://diogorainhalopes.github.io/quartz//assets/data_access.png width=auto alt></p><p>Log example:
<img src=https://diogorainhalopes.github.io/quartz//assets/log_ex.png width=auto alt></p><ol><li>We ask the OS to write the object and take note in the log of the change in the object<ul><li>In case of sys failure and are not sure if the change in disk we can check the log in case we need to replicate the change</li></ul></li><li>The OS doesnt execute the operation right away</li><li>It outputs <strong>objects</strong> in diff order of the <strong>transactions</strong></li></ol><a href=#crash><h3 id=crash><span class=hanchor arialabel=Anchor># </span><em><strong>CRASH</strong></em></h3></a><p>If crash after commits - no problem in reapplying the changes</p><a href=#redo><h4 id=redo><span class=hanchor arialabel=Anchor># </span>REDO</h4></a><ul><li>Crash between T0 commit and T1 start<ul><li>If T0 commits, we re-write the new A and B values</li><li>after sometime the values will end up on disk</li></ul></li></ul><a href=#undo><h4 id=undo><span class=hanchor arialabel=Anchor># </span>UNDO</h4></a><ul><li>Crash before T0 commit<ul><li>If T0 doesnt commit, the transaction is incomplete, the state is incomplete and have to go back to consistent</li><li>We go back to the &ldquo;old&rdquo; values, 1000 and 2000, because we dont know the values at crash</li></ul></li><li><strong>CLR</strong>: Each time we UNDO, we have to take log of the event. its a <strong>CLR</strong> (Compensation Log Record)</li></ul><p>See Slides for examples (18)</p><a href=#checkpoints><h2 id=checkpoints><span class=hanchor arialabel=Anchor># </span>Checkpoints</h2></a><p><img src=https://diogorainhalopes.github.io/quartz//assets/checkpoints.png width=auto alt></p><p>Recovery after system failure:</p><ul><li>Ignore <strong>T1</strong> (updates already output to disk due to checkpoint)</li><li>Redo <strong>T2</strong> and <strong>T3</strong></li><li>Undo <strong>T4</strong>
During recovery we need to consider only the most recent transaction Ti that started before the checkpoint, and transactions that started after Ti</li></ul><p>Example not in image:</p><ul><li>T5 starts before checkpoint and is incomplete as failure</li><li><strong>MUST BE UNDO</strong> until checkpoint <strong>AND BEFORE</strong></li><li>When <strong>REDO</strong> we only have to redo from checkpoint</li></ul><a href=#recovery-algorithm><h2 id=recovery-algorithm><span class=hanchor arialabel=Anchor># </span>Recovery Algorithm</h2></a><ul><li>Logging<ol><li>Start log</li><li>Update log</li><li>Commit log</li></ol></li><li>Transaction Rollback (normal, no crash)<ul><li>Scan from end</li><li>perform <strong>UNDO</strong></li><li>write <strong>CLR</strong></li><li>write <strong>Abort</strong> log</li></ul></li><li>Recovery from failure: Two phases<ul><li><strong>REDO</strong> phase: replay updates of all transactions, whether they committed, aborted, or are incomplete</li><li><strong>UNDO</strong> phase: undo all incomplete transactions</li></ul></li></ul><p><strong>REDO</strong> phase</p><ol><li>Find last &lt; checkpoint L > record, and set undo list to L</li><li>Scan forward from above &lt; checkpoint L > record<ol><li>Whenever a record &lt; Ti Xj , V1 , V2> or &lt;Ti , Xj , V2> is found, <strong>REDO</strong> it by writing V2 to Xj</li><li>Whenever a log record &lt; Ti > start is found, add &lt; Ti > to undo list</li><li>Whenever a log record &lt; Ti commit > or &lt; Ti abort > is found, remove Ti from undo list</li></ol></li></ol><p><strong>UNDO</strong> phase:</p><ol><li>Scan log backwards from end</li><li>Whenever a log record &lt; Ti Xj V1 , V2 > is found where Ti is in <strong>UNDO</strong> list perform the following rollback actions:<ol><li>perform <strong>UNDO</strong> by writing V1 to Xj</li><li>write a <strong>CLR</strong> <ti xj v1></li></ol></li><li>Whenever a log record Ti start is found where Ti is in UNDO list,<ol><li>Write a log record &lt; Ti abort ></li><li>Remove Ti from <strong>UNDO</strong> list</li></ol></li><li>Stop when <strong>UNDO</strong> list is empty<ol><li>i.e. &lt; Ti start > has been found for every transaction in <strong>UNDO</strong> list</li></ol></li></ol><p>After undo phase completes, normal transaction processing can commence</p><a href=#aries><h2 id=aries><span class=hanchor arialabel=Anchor># </span>ARIES</h2></a><p><em>Algorithm for Recovery and Isolation Exploiting</em></p><p>In ARIES,</p><ul><li>Blocks are called <strong>pages</strong></li><li>Every log record has a log sequence number (<strong>LSN</strong>)</li><li>Every <strong>page</strong> in the database contains the <strong>LSN</strong> of the most recent log record that changed that page<ul><li>This is called the <strong>pageLSN</strong></li><li>Updating a page creates a new log record and sets the <strong>pageLSN</strong> of that page to the <strong>LSN</strong> of that log record.</li></ul></li><li>Each log record contains a pointer to the previous log record of the same transaction<ul><li>This is called the <strong>prevLSN</strong></li><li>The first log record of a transaction has <strong>prevLSN</strong> = NULL</li></ul></li></ul><p>Besides the log, ARIES RECONSTRUCTS the two additional data structures</p><ul><li><p><strong>Dirty page table</strong></p><ul><li>Contains one entry for each <strong>dirty page</strong> in the buffer, i.e. a page with changes that are not yet reflected on disk.</li><li>Each entry contains a recLSN , which is the LSN of the first log record that caused the page to become dirty.</li></ul></li><li><p><strong>Transaction table</strong></p><ul><li>Contains one entry for each active transaction</li><li>Each entry contains a <strong>lastLSN</strong> , which is the <strong>LSN</strong> of the most recent log record for the transaction.</li></ul></li></ul><a href=#recovery-in-aries><h3 id=recovery-in-aries><span class=hanchor arialabel=Anchor># </span>Recovery in ARIES</h3></a><p>SQL Server uses.</p><ol><li><strong>Analysis</strong> - Reconstruct dirty page table and active transaction table</li><li><strong>Redo</strong> - Repeats <strong>all</strong> actions, starting from an appropriate checkpoint in the log (first entry in DIRTY PAGES TABLE), and restores the database state to what it was at the time of the crash (re-writes).</li><li><strong>Undo</strong> - Undoes the actions of transactions that did not commit (TRANSACTION TABLE), so that the database reflects only the actions of committed transactions.</li><li><strong>CLR</strong>s are to be <strong>redone</strong>, <strong>never</strong> to be <strong>undone</strong></li></ol><p><img src=https://diogorainhalopes.github.io/quartz//assets/recov_aries.png width=auto alt></p><p>See Slides for examples (38~44)
<strong>Note</strong>:</p><p>ARIES uses a log-based approach to recover from failures. It maintains a write-ahead log (WAL) that records all updates made by transactions before they are written to the database.</p><ul><li>There is a special &lt; Ti end > event that marks the end of a transaction (when it has been committed or completely rolled</li><li>The &lt; Ti abort > event <strong>does not</strong> indicate when a transaction has been completely undone (this is indicated by &lt; Ti end >)</li><li>&lt; Ti abort > indicates when a transaction error occurred</li></ul><p>The distinction between <strong>end</strong> and <strong>commit</strong> is unclear (couldn&rsquo;t get a clear answear from Chat-GPT)</p><p><a class="internal-link broken">ARIES_ex1.png</a></p><p><a href=/quartz/Lectures/Lecture-7-Transactions-and-concurrency-pt2/ rel=noopener class=internal-link data-src=/quartz/Lectures/Lecture-7-Transactions-and-concurrency-pt2/>Lecture 7 Transactions and concurrency pt2</a> |</p></article><hr><div class=page-end id=footer><div class=backlinks-container><h3>Backlinks</h3><ul class=backlinks><li><a href=/quartz/Lectures/Index-Lecture-Notes/ data-ctx="Lecture 8 Database Recovery" data-src=/Lectures/Index-Lecture-Notes class=internal-link>Index Lecture Notes</a></li><li><a href=/quartz/Lectures/Lecture-7-Transactions-and-concurrency-pt2/ data-ctx="Lecture 8 Database Recovery" data-src=/Lectures/Lecture-7-Transactions-and-concurrency-pt2 class=internal-link>Lecture 7 - Transactions and concurrency pt.2</a></li></ul></div><div><script async src=https://cdn.jsdelivr.net/npm/d3@6.7.0/dist/d3.min.js integrity="sha256-+7jaYCp29O1JusNWHaYtgUn6EhuP0VaFuswhNV06MyI=" crossorigin=anonymous></script><h3>Interactive Graph</h3><div id=graph-container></div><style>:root{--g-node:var(--secondary);--g-node-active:var(--primary);--g-node-inactive:var(--visited);--g-link:var(--outlinegray);--g-link-active:#5a7282}</style><script src=https://diogorainhalopes.github.io/quartz/js/graph.6579af7b10c818dbd2ca038702db0224.js></script></div></div><div id=contact_buttons><footer><p>Made by Diogo Lopes using <a href=https://github.com/jackyzha0/quartz>Quartz</a>, © 2023</p><ul><li><a href=https://diogorainhalopes.github.io/quartz/>Home</a></li><li><a href=https://github.com/diogorainhalopes>GitHub</a></li></ul></footer></div></div></body></html>