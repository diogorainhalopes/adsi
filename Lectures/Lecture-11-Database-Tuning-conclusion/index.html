<!doctype html><html lang=en><head><meta charset=utf-8><meta name=description content="Slides
MORE TUNING Hardware and OS tuning Threads Giving higher/lower priority to some transactions can backfire
 may cause priority inversion example  T1 (higher priority) waiting for lock from T3 (lower priority) T2 keeps running while T3 (and therefore T1) keep waiting       &ldquo;Best practice&rdquo; all threads ahev the same priority"><meta property="og:title" content="Lecture 11 - Tuning (conclusion)"><meta property="og:description" content="Slides
MORE TUNING Hardware and OS tuning Threads Giving higher/lower priority to some transactions can backfire
 may cause priority inversion example  T1 (higher priority) waiting for lock from T3 (lower priority) T2 keeps running while T3 (and therefore T1) keep waiting       &ldquo;Best practice&rdquo; all threads ahev the same priority"><meta property="og:type" content="website"><meta property="og:image" content="https://diogorainhalopes.github.io/adsi/icon.png"><meta property="og:url" content="https://diogorainhalopes.github.io/adsi/Lectures/Lecture-11-Database-Tuning-conclusion/"><meta property="og:width" content="200"><meta property="og:height" content="200"><meta name=twitter:card content="summary"><meta name=twitter:title content="Lecture 11 - Tuning (conclusion)"><meta name=twitter:description content="Slides
MORE TUNING Hardware and OS tuning Threads Giving higher/lower priority to some transactions can backfire
 may cause priority inversion example  T1 (higher priority) waiting for lock from T3 (lower priority) T2 keeps running while T3 (and therefore T1) keep waiting       &ldquo;Best practice&rdquo; all threads ahev the same priority"><meta name=twitter:image content="https://diogorainhalopes.github.io/adsi/icon.png"><title>Lecture 11 - Tuning (conclusion)</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" type=image/png href=https://diogorainhalopes.github.io/adsi//icon.png><link href=https://diogorainhalopes.github.io/adsi/styles.b369a84b3c6e6bfd686ad1f9da65641c.min.css rel=stylesheet><link href=https://diogorainhalopes.github.io/adsi/styles/_light_syntax.86a48a52faebeaaf42158b72922b1c90.min.css rel=stylesheet id=theme-link><script src=https://diogorainhalopes.github.io/adsi/js/darkmode.8f4577ddc9f8f98224343bd749bb237a.min.js></script>
<script src=https://diogorainhalopes.github.io/adsi/js/util.a0ccf91e1937fe761a74da4946452710.min.js></script>
<link rel=preload href=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css as=style onload='this.onload=null,this.rel="stylesheet"' integrity=sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js integrity=sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.2/dist/contrib/copy-tex.min.js integrity=sha384-ww/583aHhxWkz5DEVn6OKtNiIaLi2iBRNZXfJRiY1Ai7tnJ9UXpEsyvOITVpTl4A crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/@floating-ui/core@1.2.1></script>
<script src=https://cdn.jsdelivr.net/npm/@floating-ui/dom@1.2.1></script>
<script async src=https://diogorainhalopes.github.io/adsi/js/popover.aa9bc99c7c38d3ae9538f218f1416adb.min.js></script>
<script defer src=https://diogorainhalopes.github.io/adsi/js/code-title.ce4a43f09239a9efb48fee342e8ef2df.min.js></script>
<script defer src=https://diogorainhalopes.github.io/adsi/js/clipboard.2913da76d3cb21c5deaa4bae7da38c9f.min.js></script>
<script defer src=https://diogorainhalopes.github.io/adsi/js/callouts.7723cac461d613d118ee8bb8216b9838.min.js></script>
<script>const SEARCH_ENABLED=!1,LATEX_ENABLED=!0,PRODUCTION=!0,BASE_URL="https://diogorainhalopes.github.io/adsi/",fetchData=Promise.all([fetch("https://diogorainhalopes.github.io/adsi/indices/linkIndex.c3bd07ecdfd093be58bd4a0a0699d821.min.json").then(e=>e.json()).then(e=>({index:e.index,links:e.links})),fetch("https://diogorainhalopes.github.io/adsi/indices/contentIndex.41756058efb0d28e372c2fd3ad13b8a6.min.json").then(e=>e.json())]).then(([{index:e,links:t},n])=>({index:e,links:t,content:n})),render=()=>{const e=new URL(BASE_URL),t=e.pathname,n=window.location.pathname,s=t==n;addCopyButtons(),addTitleToCodeBlocks(),addCollapsibleCallouts(),initPopover("https://diogorainhalopes.github.io/adsi",!0);const o=document.getElementById("footer");if(o){const e=document.getElementById("graph-container");if(!e)return requestAnimationFrame(render);e.textContent="";const t=s&&!0;drawGraph("https://diogorainhalopes.github.io/adsi",t,[{"/moc":"#4388cc"}],t?{centerForce:1,depth:2,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.5,linkDistance:1,opacityScale:3,repelForce:1,scale:1.4}:{centerForce:1,depth:2,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.6,linkDistance:1,opacityScale:3,repelForce:2,scale:1.2})}function i(n){const e=n.target,t=e.className.split(" "),s=t.includes("broken"),o=t.includes("internal-link");plausible("Link Click",{props:{href:e.href,broken:s,internal:o,graph:!1}})}const a=document.querySelectorAll("a");for(link of a)link.className.includes("root-title")&&link.addEventListener("click",i,{once:!0})},init=(e=document)=>{addCopyButtons(),addTitleToCodeBlocks(),renderMathInElement(e.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],macros:{'’':"'"},throwOnError:!1})}</script><script type=module>
    import { attachSPARouting } from "https:\/\/diogorainhalopes.github.io\/adsi\/js\/router.d6fe6bd821db9ea97f9aeefae814d8e7.min.js"
    attachSPARouting(init, render)
  </script><script defer data-domain=diogorainhalopes.github.io/adsi src=https://plausible.io/js/script.js></script>
<script>window.plausible=window.plausible||function(){(window.plausible.q=window.plausible.q||[]).push(arguments)}</script></head><body><div id=search-container><div id=search-space><input autocomplete=off id=search-bar name=search type=text aria-label=Search placeholder="Search for something..."><div id=results-container></div></div></div><script src=https://cdn.jsdelivr.net/npm/flexsearch@0.7.21/dist/flexsearch.bundle.js integrity="sha256-i3A0NZGkhsKjVMzFxv3ksk0DZh3aXqu0l49Bbh0MdjE=" crossorigin=anonymous defer></script>
<script defer src=https://diogorainhalopes.github.io/adsi/js/full-text-search.e6e2e0c213187ca0c703d6e2c7a77fcd.min.js></script><div class=singlePage><header><h1 id=page-title><a class=root-title href=https://diogorainhalopes.github.io/adsi/>ADSI Notes - Diogo Lopes</a></h1><div class=spacer></div><div id=search-icon><p>Search</p><svg tabindex="0" aria-labelledby="title desc" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title id="title">Search Icon</title><desc id="desc">Icon to open search</desc><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"/><circle cx="8" cy="8" r="7"/></g></svg></div><div class=darkmode><input class=toggle id=darkmode-toggle type=checkbox tabindex=-1>
<label id=toggle-label-light for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="dayIcon" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35"><title>Light Mode</title><path d="M6 17.5C6 16.672 5.328 16 4.5 16h-3C.672 16 0 16.672.0 17.5S.672 19 1.5 19h3C5.328 19 6 18.328 6 17.5zM7.5 26c-.414.0-.789.168-1.061.439l-2 2C4.168 28.711 4 29.086 4 29.5 4 30.328 4.671 31 5.5 31c.414.0.789-.168 1.06-.44l2-2C8.832 28.289 9 27.914 9 27.5 9 26.672 8.329 26 7.5 26zm10-20C18.329 6 19 5.328 19 4.5v-3C19 .672 18.329.0 17.5.0S16 .672 16 1.5v3C16 5.328 16.671 6 17.5 6zm10 3c.414.0.789-.168 1.06-.439l2-2C30.832 6.289 31 5.914 31 5.5 31 4.672 30.329 4 29.5 4c-.414.0-.789.168-1.061.44l-2 2C26.168 6.711 26 7.086 26 7.5 26 8.328 26.671 9 27.5 9zM6.439 8.561C6.711 8.832 7.086 9 7.5 9 8.328 9 9 8.328 9 7.5c0-.414-.168-.789-.439-1.061l-2-2C6.289 4.168 5.914 4 5.5 4 4.672 4 4 4.672 4 5.5c0 .414.168.789.439 1.06l2 2.001zM33.5 16h-3c-.828.0-1.5.672-1.5 1.5s.672 1.5 1.5 1.5h3c.828.0 1.5-.672 1.5-1.5S34.328 16 33.5 16zM28.561 26.439C28.289 26.168 27.914 26 27.5 26c-.828.0-1.5.672-1.5 1.5.0.414.168.789.439 1.06l2 2C28.711 30.832 29.086 31 29.5 31c.828.0 1.5-.672 1.5-1.5.0-.414-.168-.789-.439-1.061l-2-2zM17.5 29c-.829.0-1.5.672-1.5 1.5v3c0 .828.671 1.5 1.5 1.5s1.5-.672 1.5-1.5v-3C19 29.672 18.329 29 17.5 29zm0-22C11.71 7 7 11.71 7 17.5S11.71 28 17.5 28 28 23.29 28 17.5 23.29 7 17.5 7zm0 18c-4.136.0-7.5-3.364-7.5-7.5s3.364-7.5 7.5-7.5 7.5 3.364 7.5 7.5S21.636 25 17.5 25z"/></svg></label><label id=toggle-label-dark for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="nightIcon" viewBox="0 0 100 100" style="enable-background='new 0 0 100 100'"><title>Dark Mode</title><path d="M96.76 66.458c-.853-.852-2.15-1.064-3.23-.534-6.063 2.991-12.858 4.571-19.655 4.571C62.022 70.495 50.88 65.88 42.5 57.5 29.043 44.043 25.658 23.536 34.076 6.47c.532-1.08.318-2.379-.534-3.23-.851-.852-2.15-1.064-3.23-.534-4.918 2.427-9.375 5.619-13.246 9.491-9.447 9.447-14.65 22.008-14.65 35.369.0 13.36 5.203 25.921 14.65 35.368s22.008 14.65 35.368 14.65c13.361.0 25.921-5.203 35.369-14.65 3.872-3.871 7.064-8.328 9.491-13.246C97.826 68.608 97.611 67.309 96.76 66.458z"/></svg></label></div></header><article><h1>Lecture 11 - Tuning (conclusion)</h1><p class=meta>Last updated
Apr 18, 2023</p><ul class=tags></ul><aside class=mainTOC><details open><summary>Table of Contents</summary><nav id=TableOfContents><ol><li><a href=#hardware-and-os-tuning>Hardware and OS tuning</a><ol><li><a href=#threads>Threads</a></li><li><a href=#database-buffer>Database Buffer</a></li><li><a href=#filesystem>Filesystem</a></li><li><a href=#raid-levels>RAID Levels</a></li><li><a href=#controller-cache>Controller Cache</a></li><li><a href=#hardware-configuration>Hardware Configuration</a></li></ol></li><li><a href=#database-monitoring--troubleshooting>Database monitoring / troubleshooting</a><ol><li><a href=#producer-consumer-hierarchy>Producer-consumer hierarchy</a></li><li><a href=#performance-problems>Performance Problems</a></li><li><a href=#systematic-approach-three-questions>Systematic Approach: Three Questions</a></li><li><a href=#monitoring-tools>Monitoring Tools</a></li><li><a href=#investigating-high-level-consumers>Investigating High-Level Consumers</a></li><li><a href=#investigating-intermediate-resourcesconsumers>Investigating Intermediate Resources/Consumers</a></li><li><a href=#investigating-primary-resources>Investigating Primary Resources</a></li></ol></li></ol></nav></details></aside><p><a href=https://diogorainhalopes.github.io/adsi/slides/adsi-10-tuning.pdf rel=noopener>Slides</a></p><a href=#more-tuning><h1 id=more-tuning><span class=hanchor arialabel=Anchor># </span>MORE TUNING</h1></a><a href=#hardware-and-os-tuning><h2 id=hardware-and-os-tuning><span class=hanchor arialabel=Anchor># </span>Hardware and OS tuning</h2></a><a href=#threads><h3 id=threads><span class=hanchor arialabel=Anchor># </span>Threads</h3></a><p>Giving higher/lower priority to some transactions can backfire</p><ul><li>may cause <em><strong>priority inversion</strong></em></li><li>example<ul><li>T1 (higher priority) waiting for lock from T3 (lower priority)</li><li>T2 keeps running while T3 (and therefore T1) keep waiting</li></ul></li></ul><p><img src=https://diogorainhalopes.github.io/adsi//assets/thread_prio.png width=auto alt></p><ul><li><p>&ldquo;Best practice&rdquo; all threads ahev the same priority</p></li><li><p>Some systems use <em><strong>priority inheritance</strong></em></p><ul><li>When T1 requests lock on X, the priority of T3 is increased to that of T1</li><li>If priority inheritance is unavailable, give same priority to all threads</li></ul></li><li><p>In SQL Server, there was <em><strong>priority boosting</strong></em></p><ul><li>Giving more priority to the database system than to the OS</li><li>Did not work out as expected, has been discontinued</li></ul></li></ul><a href=#database-buffer><h3 id=database-buffer><span class=hanchor arialabel=Anchor># </span>Database Buffer</h3></a><ul><li>Ideally, store as much as possible in RAM to avoid disk accesses</li><li>Goal of <strong>memory tuning</strong><ul><li>Frequently read pages should rarely require disk accesses</li></ul></li><li>Logical vs. physical reads<ul><li>Logical reads: pages that need to be accessed</li><li>Physical reads: pages that need to be retrieved from disk</li></ul></li><li>Logical vs. physical writes<ul><li>Logical writes: changes to pages in the buffer (dirty pages)</li><li>Physical writes: dirty pages are written to disk</li></ul></li><li>Page replacements<ul><li>Dirty pages are written to disk to free buffer space</li><li>New pages are read from disk into the free buffer space</li></ul></li></ul><blockquote><p><em>Goal is Logical Reads without physical action</em></p></blockquote><p>Assuming OS paging and page replacements are low</p><p><img src=https://diogorainhalopes.github.io/adsi//assets/hit_RATIO.png width=auto alt></p><ul><li>Aim for hit ratio > <strong>90%</strong></li><li>Run typical workload and check hit ratio</li><li>Increase buffer size until hit ratio flattens out</li></ul><p>Experiment with full table scan</p><ul><li>If buffer size is small, table must be read entirely from disk<ul><li>LRU replacement strategy keeps evicting pages from memory</li></ul></li><li>If buffer size is large, the entire table fits in memory<ul><li>Query is processed entirely from RAM</li></ul></li></ul><p><img src=https://diogorainhalopes.github.io/adsi//assets/buffer_size.png width=auto alt></p><p>Suddenly the WHOLE TABLE can fit in memory. Beyond this point, you dont need more buffer size (for this query)</p><a href=#filesystem><h3 id=filesystem><span class=hanchor arialabel=Anchor># </span>Filesystem</h3></a><p>Size of disk chunks allocated at one time</p><ul><li>Some file systems call these <strong>extents</strong><ul><li>In SQL Server, an extent is 8 physically <strong>contiguous pages</strong> (sequential data. A single seek can read them)</li></ul></li><li>Allocate large extents to files that need to be scanned often</li><li>Sequential files such as <em>log</em> or <em>history</em> also benefit form <strong>large</strong> extents</li></ul><p><strong>Usage factor</strong> of disk pages</p><ul><li>Some pages are full, others are not (bad)<ul><li><strong>High usage factor</strong> (90% or higher) is good for table <strong>scans</strong> / <em>reads</em></li><li><strong>Low usage factor</strong> (70% or less) is good for frequent <strong>insertions</strong> / <em>writes</em></li></ul></li><li>In SQL Server, there is also an <em><strong>index fill factor</strong></em><ul><li>percentage of space on each leaf-level page to be filled with data</li></ul></li><li>Q: What can we do?</li><li>A: <strong>Index Maintenance</strong>; we often rebuild indexes to reduce their internal fragmentation</li></ul><p>Experiment with full table scan</p><ul><li>Cold buffer (empty memory) to read entire table from disk</li><li>Throughput improves by about 10% when <strong>usage factor</strong> is increased from <strong>70%</strong> to <strong>100%</strong></li></ul><p><img src=https://diogorainhalopes.github.io/adsi//assets/usage_FACTOR.png width=auto alt></p><p>Pre-fetching pages from disk</p><ul><li>Speed up table/index scans by reading ahead more pages from disk</li><li>Experiment with full table scan<ul><li>Throughput improves by about 10% when the prefetching size is increased from 32 KB to 128 KB</li></ul></li></ul><p><img src=https://diogorainhalopes.github.io/adsi//assets/prefetch.png width=auto alt></p><a href=#raid-levels><h3 id=raid-levels><span class=hanchor arialabel=Anchor># </span>RAID Levels</h3></a><ul><li>RAID level 0<ul><li>Block striping (round robin block selection), non-redundant (data is lost)</li></ul></li><li>RAID level 1<ul><li>Mirrored disks with block striping*</li></ul></li><li>RAID level 5<ul><li>Block-interleaved distributed parity
(
<a rel=noopener class="internal-link broken" data-src=Lectures/Lecture-2-Storage-and-file-organization#raid---redundant-arrays-of-independent-disks>see</a>)</li></ul></li></ul><a href=#database-log><h4 id=database-log><span class=hanchor arialabel=Anchor># </span>Database log</h4></a><ul><li>RAID 1 is appropriate for log file(s)<ul><li>Mirroring provides fault tolerance with high write throughput</li><li>Writes are synchronous and sequential; no benefit from striping</li><li>We dont want to waste time in checksums (need fast access)</li></ul></li></ul><a href=#temporary-files><h4 id=temporary-files><span class=hanchor arialabel=Anchor># </span>Temporary Files</h4></a><ul><li>RAID 0 is appropriate for temporary tables or sorting files<ul><li>No fault tolerance, high throughput; system can tolerate data loss</li><li>when data doesnt fit in memory we need &ldquo;temporary runs&rdquo; (temp files) to store some memory (like in sorts or intermediate values)</li></ul></li></ul><a href=#data-and-index-files><h4 id=data-and-index-files><span class=hanchor arialabel=Anchor># </span>Data and index files</h4></a><ul><li><p>RAID 5 provides fault tolerance and is best suited for read intensive apps</p></li><li><p>Read performance</p><ul><li>RAID 0, RAID 1, RAID 5 improve read performance with multiple disks</li></ul></li><li><p>Write performance</p><ul><li>Negative impact of RAID 5 for computing and writing parity block (hidden by <strong>controller cache</strong> (disks internal cache))</li></ul></li></ul><p><img src=https://diogorainhalopes.github.io/adsi//assets/raidss-1.png width=auto alt></p><a href=#controller-cache><h3 id=controller-cache><span class=hanchor arialabel=Anchor># </span>Controller Cache</h3></a><p>Disk controllers have memory that servers as cache</p><ul><li>On read operations, the cache can be used for <strong>read-ahead</strong></li><li>On write operations, the cache can be used for <strong>write-back</strong></li></ul><p>Experiments with write-back mode</p><ul><li>Cache friendly: the data volume is slightly larger than cache</li><li>Cache unfriendly: the data volume is 10x larger than cache<ul><li>when cache is full, requests are serialized and waiting time increases</li><li>depends on disk access time and on length of waiting queue
The disk will tell us that its written when in disk controller</li></ul></li></ul><p><img src=https://diogorainhalopes.github.io/adsi//assets/disck_contr.png width=auto alt></p><a href=#hardware-configuration><h3 id=hardware-configuration><span class=hanchor arialabel=Anchor># </span>Hardware Configuration</h3></a><ul><li><p><strong>Add memory</strong></p><ul><li>Allows increase in buffer size</li><li>Reduces load on disks</li><li>Increases the hit ratio</li><li>Reduces page replacement and OS paging</li></ul></li><li><p>Add disks</p><ul><li>Put the <strong>log on a separate disk</strong> to ensure that writes are sequential (most important)</li><li>Use a different <strong>RAID level</strong> to achieve better write performance<ul><li>e.g. switch from RAID 5 to RAID 1 for write-intensive apps</li></ul></li><li><strong>Partition large tables</strong> across several disks<ul><li>Write-intensive apps should have non-clustered indexes to separate disk, because each modification updates those indexes</li></ul></li><li>Read-intensive apps should partition tables across multiple disks to balance the read load (can be achieved just by using RAID)</li></ul></li><li><p><strong>Add processors</strong></p><ul><li>Off-load non-database tasks to other processors</li><li>Provide computing power for data mining apps on copy of database</li><li>Connect many independent systems together by a high-speed network<ul><li>Different options for sharing resources (memory, disks, processors)</li></ul></li></ul></li><li><p>Shared-everything, shared-disks, or shared-nothing environment</p></li></ul><a href=#database-monitoring--troubleshooting><h2 id=database-monitoring--troubleshooting><span class=hanchor arialabel=Anchor># </span>Database monitoring / troubleshooting</h2></a><p><img src=https://diogorainhalopes.github.io/adsi//assets/monit.png width=auto alt></p><p><img src=https://diogorainhalopes.github.io/adsi//assets/consu.png width=auto alt></p><a href=#producer-consumer-hierarchy><h3 id=producer-consumer-hierarchy><span class=hanchor arialabel=Anchor># </span>Producer-consumer hierarchy</h3></a><ul><li>High-level consumers<ul><li>Users or applications issuing SQL queries or database commands</li></ul></li><li>Intermediate consumers/resources<ul><li>Database subsystems that interact with each another those requests</li></ul></li><li>Primary resources<ul><li>Raw resources of the machine being managed by the OS</li></ul></li></ul><a href=#performance-problems><h3 id=performance-problems><span class=hanchor arialabel=Anchor># </span>Performance Problems</h3></a><p><img src=https://diogorainhalopes.github.io/adsi//assets/perfp1.png width=auto alt></p><ul><li><p>Better eg. for intermediate resources problem. We have a certain DB configuration that exhaustes a certain resource (<strong>lock escalation</strong>)
<img src=https://diogorainhalopes.github.io/adsi//assets/perfp2.png width=auto alt></p></li><li><p>Better eg. for Primary resources problem. All our queries result in physical reads
<img src=https://diogorainhalopes.github.io/adsi//assets/perfp3.png width=auto alt></p></li></ul><a href=#systematic-approach-three-questions><h3 id=systematic-approach-three-questions><span class=hanchor arialabel=Anchor># </span>Systematic Approach: Three Questions</h3></a><a href=#1-are-critical-queries-being-served-in-the-most-efficient-manner><h4 id=1-are-critical-queries-being-served-in-the-most-efficient-manner><span class=hanchor arialabel=Anchor># </span>1. Are critical queries being served in the most efficient manner?</h4></a><ul><li>High-level consumer question</li></ul><a href=#2-are-database-subsystems-making-optimal-use-of-resources><h4 id=2-are-database-subsystems-making-optimal-use-of-resources><span class=hanchor arialabel=Anchor># </span>2. Are database subsystems making optimal use of resources?</h4></a><ul><li>Intermediate consumer/resource question</li></ul><a href=#3-are-there-enough-primary-resources-for-the-expected-workload><h4 id=3-are-there-enough-primary-resources-for-the-expected-workload><span class=hanchor arialabel=Anchor># </span>3. Are there enough primary resources for the expected workload?</h4></a><ul><li>Primary resources question</li></ul><a href=#critical-query-monitoring><h4 id=critical-query-monitoring><span class=hanchor arialabel=Anchor># </span>Critical Query Monitoring</h4></a><p><img src=https://diogorainhalopes.github.io/adsi//assets/q1.png width=auto alt></p><a href=#routine-monitoring><h4 id=routine-monitoring><span class=hanchor arialabel=Anchor># </span>Routine Monitoring</h4></a><p><img src=https://diogorainhalopes.github.io/adsi//assets/q2n3.png width=auto alt></p><a href=#monitoring-tools><h3 id=monitoring-tools><span class=hanchor arialabel=Anchor># </span>Monitoring Tools</h3></a><ul><li><strong>Query Plan Explainers</strong><ul><li>Shows the execution plan and estimated costs</li></ul></li><li><strong>Performance Monitors</strong><ul><li>Tools that access the database internal counters and metrics</li></ul></li><li><strong>Event Monitors</strong><ul><li>Record performance measures only when an event occurs</li></ul></li></ul><a href=#investigating-high-level-consumers><h3 id=investigating-high-level-consumers><span class=hanchor arialabel=Anchor># </span>Investigating High-Level Consumers</h3></a><ul><li>Answer question 1<ul><li>Are critical queries being served in the most efficient manner?</li></ul></li></ul><ol><li><strong>Identify the critical queries</strong><ul><li>Use Event Monitor to find end-of-statement with execution measures</li></ul></li></ol><p><img src=https://diogorainhalopes.github.io/adsi//assets/evmon.png width=auto alt></p><ol start=2><li><strong>Analyze the execution plan</strong><ul><li>Use Query Plan Explainer to analyze the relative cost of each operation</li></ul></li></ol><p><img src=https://diogorainhalopes.github.io/adsi//assets/qpexpl.png width=auto alt></p><p>In the execution plan, pay attention to:</p><ul><li>Access methods<ul><li>sequential scan, index lookup, etc.</li></ul></li><li>Sorts<ul><li>caused by ORDER BY, GROUP BY or DISTINCT</li></ul></li><li>Intermediate results<ul><li>materialization to temporaries</li></ul></li><li>Order of operations<ul><li>joins, sorts, aggregations, filtering</li></ul></li><li>Algorithms used in operations<ul><li>types of join, etc.</li></ul></li></ul><ol start=3><li>Profile the execution<ul><li>Use Performance Monitor to analyze duration and resource consumption</li></ul></li></ol><p><img src=https://diogorainhalopes.github.io/adsi//assets/perfmon.png width=auto alt></p><p>Duration involves 3 indicators:</p><ul><li>Elapsed time<ul><li>The time it took to process the query as perceived by a user</li></ul></li><li>CPU time<ul><li>The time that was actually used by the CPU to process the query</li></ul></li><li>Wait time<ul><li>The time the query was waiting for a resources to become available</li></ul></li></ul><p>Two common scenarios</p><ul><li>Elapsed time close to <strong>CPU time</strong><ul><li>Probably difficult to optimize any further</li></ul></li><li>Discrepancy between <strong>elapsed time</strong> and <strong>CPU time</strong><ul><li>Points to a problem in resource consumption</li><li>Possibly a contention problem or a poorly performing resource</li><li>Run the query in isolation to investigate the cause</li></ul></li></ul><a href=#investigating-intermediate-resourcesconsumers><h3 id=investigating-intermediate-resourcesconsumers><span class=hanchor arialabel=Anchor># </span>Investigating Intermediate Resources/Consumers</h3></a><ul><li>Answer question 2<ul><li>Are database subsystems making optimal use of resources?</li></ul></li></ul><ol><li><strong>Disk subsystem</strong><ul><li>A table should be stored contiguously in a physical disk<ul><li>Avoid free space between records (<strong>data fragmentation</strong>)</li></ul></li><li>Table records should be stored in their correct order<ul><li>Avoid records out of place (<strong>row displacement</strong>)</li></ul></li><li>Periodic file reorganization may be necessary</li></ul></li></ol><p><img src=https://diogorainhalopes.github.io/adsi//assets/storehier.png width=auto alt></p><ol start=2><li><strong>Buffer manager</strong><ul><li>Two main performance indicators to monitor<ul><li><strong>Hit ratio</strong> – percentage of times that requested page is already in buffer</li><li>Nu<strong>mber of free pages</strong> – how much space is left in the buffer</li></ul></li><li>In SQL Server, these and other metrics can be obtained from system views</li></ul></li></ol><p><img src=https://diogorainhalopes.github.io/adsi//assets/buffman.png width=auto alt></p><ol start=3><li><strong>Locking subsystem</strong><ul><li>Useful indicators<ul><li>Average lock wait time</li><li>Number of locks on wait</li><li>Number of deadlocks or timeouts</li></ul></li><li>SQL Server provides comprehensive wait statistics through system views</li></ul></li></ol><p><img src=https://diogorainhalopes.github.io/adsi//assets/locklist.png width=auto alt></p><ol start=4><li>Logging subsystem<ul><li>Useful indicators<ul><li>Number of log waits – ensure log can keep up with transactions</li><li>Log expansions or log archives – due to lack of space</li><li>Log cache hit ratio – analogous to buffer cache hit ratio</li></ul></li><li>Log waits > 0 means transactions are being held due to log writes</li></ul></li></ol><a href=#investigating-primary-resources><h3 id=investigating-primary-resources><span class=hanchor arialabel=Anchor># </span>Investigating Primary Resources</h3></a><ul><li>Answer question 3<ul><li>Are there enough primary resources for the expected workload?</li></ul></li></ul><ol><li>CPU<ul><li>Main indicator<ul><li><strong>Percentage of utilization</strong></li></ul></li><li>Use OS task manager to monitor CPU utilization</li><li>Identify whether processes are database or non-database related</li><li>Check CPU utilization of system (OS) processes in idle state</li></ul></li></ol><p><img src=https://diogorainhalopes.github.io/adsi//assets/cpusuage.png width=auto alt></p><ol start=2><li>Disks<ul><li>Main indicators<ul><li>Average size of the waiting queue</li><li>Average time taken to service a request</li><li>Bytes transferred per second</li></ul></li><li>Disk utilization can be monitored with OS utilities</li></ul></li></ol><p><img src=https://diogorainhalopes.github.io/adsi//assets/disktr.png width=auto alt></p><ol start=3><li>Memory<ul><li>Some indicators<ul><li>Number of page faults/time</li><li>Percentage of paging file in use</li></ul></li><li>Size of paging/swap file is an indication of how much memory is lacking</li></ul></li></ol><p><img src=https://diogorainhalopes.github.io/adsi//assets/memusa.png width=auto alt></p><p><a href=/adsi/Lectures/Lecture-10-Database-Tuning-continued/ rel=noopener class=internal-link data-src=/adsi/Lectures/Lecture-10-Database-Tuning-continued/>Lecture 10 Tuning (continued)</a></p></article><hr><div class=page-end id=footer><div class=backlinks-container><h3>Backlinks</h3><ul class=backlinks><li><a href=/adsi/Lectures/Index-Lecture-Notes/ data-ctx="Lecture 11 Database Tuning (conclusion)" data-src=/Lectures/Index-Lecture-Notes class=internal-link>Index Lecture Notes</a></li><li><a href=/adsi/Lectures/Lecture-10-Database-Tuning-continued/ data-ctx="Lecture 11 Tuning" data-src=/Lectures/Lecture-10-Database-Tuning-continued class=internal-link>Lecture 10 - Tuning (continued)</a></li></ul></div><div><script async src=https://cdn.jsdelivr.net/npm/d3@6.7.0/dist/d3.min.js integrity="sha256-+7jaYCp29O1JusNWHaYtgUn6EhuP0VaFuswhNV06MyI=" crossorigin=anonymous></script><h3>Interactive Graph</h3><div id=graph-container></div><style>:root{--g-node:var(--secondary);--g-node-active:var(--primary);--g-node-inactive:var(--visited);--g-link:var(--outlinegray);--g-link-active:#5a7282}</style><script src=https://diogorainhalopes.github.io/adsi/js/graph.6579af7b10c818dbd2ca038702db0224.js></script></div></div><div id=contact_buttons><footer><p>Made by Diogo Lopes using <a href=https://github.com/jackyzha0/quartz>Quartz</a>, © 2023</p><ul><li><a href=https://diogorainhalopes.github.io/adsi/>Home</a></li><li><a href=https://github.com/diogorainhalopes>GitHub</a></li></ul></footer></div></div></body></html>