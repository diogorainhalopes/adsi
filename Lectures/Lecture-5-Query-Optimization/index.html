<!doctype html><html lang=en><head><meta charset=utf-8><meta name=description content="Slides
Query Optimization Evaluating a given query  Query optimization is finding the optimal execution plan
  From a) to b) we change the plan because we only join the rows we want, which translates in a better performance becasue has smaller intermediate results"><meta property="og:title" content="Lecture 5 - Query Optimization"><meta property="og:description" content="Slides
Query Optimization Evaluating a given query  Query optimization is finding the optimal execution plan
  From a) to b) we change the plan because we only join the rows we want, which translates in a better performance becasue has smaller intermediate results"><meta property="og:type" content="website"><meta property="og:image" content="https://diogorainhalopes.github.io/adsi/icon.png"><meta property="og:url" content="https://diogorainhalopes.github.io/adsi/Lectures/Lecture-5-Query-Optimization/"><meta property="og:width" content="200"><meta property="og:height" content="200"><meta name=twitter:card content="summary"><meta name=twitter:title content="Lecture 5 - Query Optimization"><meta name=twitter:description content="Slides
Query Optimization Evaluating a given query  Query optimization is finding the optimal execution plan
  From a) to b) we change the plan because we only join the rows we want, which translates in a better performance becasue has smaller intermediate results"><meta name=twitter:image content="https://diogorainhalopes.github.io/adsi/icon.png"><title>Lecture 5 - Query Optimization</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" type=image/png href=https://diogorainhalopes.github.io/adsi//icon.png><link href=https://diogorainhalopes.github.io/adsi/styles.b369a84b3c6e6bfd686ad1f9da65641c.min.css rel=stylesheet><link href=https://diogorainhalopes.github.io/adsi/styles/_light_syntax.86a48a52faebeaaf42158b72922b1c90.min.css rel=stylesheet id=theme-link><script src=https://diogorainhalopes.github.io/adsi/js/darkmode.8f4577ddc9f8f98224343bd749bb237a.min.js></script>
<script src=https://diogorainhalopes.github.io/adsi/js/util.a0ccf91e1937fe761a74da4946452710.min.js></script>
<link rel=preload href=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css as=style onload='this.onload=null,this.rel="stylesheet"' integrity=sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js integrity=sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.2/dist/contrib/copy-tex.min.js integrity=sha384-ww/583aHhxWkz5DEVn6OKtNiIaLi2iBRNZXfJRiY1Ai7tnJ9UXpEsyvOITVpTl4A crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/@floating-ui/core@1.2.1></script>
<script src=https://cdn.jsdelivr.net/npm/@floating-ui/dom@1.2.1></script>
<script async src=https://diogorainhalopes.github.io/adsi/js/popover.aa9bc99c7c38d3ae9538f218f1416adb.min.js></script>
<script defer src=https://diogorainhalopes.github.io/adsi/js/code-title.ce4a43f09239a9efb48fee342e8ef2df.min.js></script>
<script defer src=https://diogorainhalopes.github.io/adsi/js/clipboard.2913da76d3cb21c5deaa4bae7da38c9f.min.js></script>
<script defer src=https://diogorainhalopes.github.io/adsi/js/callouts.7723cac461d613d118ee8bb8216b9838.min.js></script>
<script>const SEARCH_ENABLED=!1,LATEX_ENABLED=!0,PRODUCTION=!0,BASE_URL="https://diogorainhalopes.github.io/adsi/",fetchData=Promise.all([fetch("https://diogorainhalopes.github.io/adsi/indices/linkIndex.94f8786fc63ebe8e05322571a173a75f.min.json").then(e=>e.json()).then(e=>({index:e.index,links:e.links})),fetch("https://diogorainhalopes.github.io/adsi/indices/contentIndex.740596be0501b98c11f8de4c923b54a8.min.json").then(e=>e.json())]).then(([{index:e,links:t},n])=>({index:e,links:t,content:n})),render=()=>{const e=new URL(BASE_URL),t=e.pathname,n=window.location.pathname,s=t==n;addCopyButtons(),addTitleToCodeBlocks(),addCollapsibleCallouts(),initPopover("https://diogorainhalopes.github.io/adsi",!0);const o=document.getElementById("footer");if(o){const e=document.getElementById("graph-container");if(!e)return requestAnimationFrame(render);e.textContent="";const t=s&&!0;drawGraph("https://diogorainhalopes.github.io/adsi",t,[{"/moc":"#4388cc"}],t?{centerForce:1,depth:2,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.5,linkDistance:1,opacityScale:3,repelForce:1,scale:1.4}:{centerForce:1,depth:2,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.6,linkDistance:1,opacityScale:3,repelForce:2,scale:1.2})}function i(n){const e=n.target,t=e.className.split(" "),s=t.includes("broken"),o=t.includes("internal-link");plausible("Link Click",{props:{href:e.href,broken:s,internal:o,graph:!1}})}const a=document.querySelectorAll("a");for(link of a)link.className.includes("root-title")&&link.addEventListener("click",i,{once:!0})},init=(e=document)=>{addCopyButtons(),addTitleToCodeBlocks(),renderMathInElement(e.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],macros:{'’':"'"},throwOnError:!1})}</script><script type=module>
    import { attachSPARouting } from "https:\/\/diogorainhalopes.github.io\/adsi\/js\/router.d6fe6bd821db9ea97f9aeefae814d8e7.min.js"
    attachSPARouting(init, render)
  </script><script defer data-domain=diogorainhalopes.github.io/adsi src=https://plausible.io/js/script.js></script>
<script>window.plausible=window.plausible||function(){(window.plausible.q=window.plausible.q||[]).push(arguments)}</script></head><body><div id=search-container><div id=search-space><input autocomplete=off id=search-bar name=search type=text aria-label=Search placeholder="Search for something..."><div id=results-container></div></div></div><script src=https://cdn.jsdelivr.net/npm/flexsearch@0.7.21/dist/flexsearch.bundle.js integrity="sha256-i3A0NZGkhsKjVMzFxv3ksk0DZh3aXqu0l49Bbh0MdjE=" crossorigin=anonymous defer></script>
<script defer src=https://diogorainhalopes.github.io/adsi/js/full-text-search.e6e2e0c213187ca0c703d6e2c7a77fcd.min.js></script><div class=singlePage><header><h1 id=page-title><a class=root-title href=https://diogorainhalopes.github.io/adsi/>ADSI Notes - Diogo Lopes</a></h1><div class=spacer></div><div id=search-icon><p>Search</p><svg tabindex="0" aria-labelledby="title desc" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title id="title">Search Icon</title><desc id="desc">Icon to open search</desc><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"/><circle cx="8" cy="8" r="7"/></g></svg></div><div class=darkmode><input class=toggle id=darkmode-toggle type=checkbox tabindex=-1>
<label id=toggle-label-light for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="dayIcon" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35"><title>Light Mode</title><path d="M6 17.5C6 16.672 5.328 16 4.5 16h-3C.672 16 0 16.672.0 17.5S.672 19 1.5 19h3C5.328 19 6 18.328 6 17.5zM7.5 26c-.414.0-.789.168-1.061.439l-2 2C4.168 28.711 4 29.086 4 29.5 4 30.328 4.671 31 5.5 31c.414.0.789-.168 1.06-.44l2-2C8.832 28.289 9 27.914 9 27.5 9 26.672 8.329 26 7.5 26zm10-20C18.329 6 19 5.328 19 4.5v-3C19 .672 18.329.0 17.5.0S16 .672 16 1.5v3C16 5.328 16.671 6 17.5 6zm10 3c.414.0.789-.168 1.06-.439l2-2C30.832 6.289 31 5.914 31 5.5 31 4.672 30.329 4 29.5 4c-.414.0-.789.168-1.061.44l-2 2C26.168 6.711 26 7.086 26 7.5 26 8.328 26.671 9 27.5 9zM6.439 8.561C6.711 8.832 7.086 9 7.5 9 8.328 9 9 8.328 9 7.5c0-.414-.168-.789-.439-1.061l-2-2C6.289 4.168 5.914 4 5.5 4 4.672 4 4 4.672 4 5.5c0 .414.168.789.439 1.06l2 2.001zM33.5 16h-3c-.828.0-1.5.672-1.5 1.5s.672 1.5 1.5 1.5h3c.828.0 1.5-.672 1.5-1.5S34.328 16 33.5 16zM28.561 26.439C28.289 26.168 27.914 26 27.5 26c-.828.0-1.5.672-1.5 1.5.0.414.168.789.439 1.06l2 2C28.711 30.832 29.086 31 29.5 31c.828.0 1.5-.672 1.5-1.5.0-.414-.168-.789-.439-1.061l-2-2zM17.5 29c-.829.0-1.5.672-1.5 1.5v3c0 .828.671 1.5 1.5 1.5s1.5-.672 1.5-1.5v-3C19 29.672 18.329 29 17.5 29zm0-22C11.71 7 7 11.71 7 17.5S11.71 28 17.5 28 28 23.29 28 17.5 23.29 7 17.5 7zm0 18c-4.136.0-7.5-3.364-7.5-7.5s3.364-7.5 7.5-7.5 7.5 3.364 7.5 7.5S21.636 25 17.5 25z"/></svg></label><label id=toggle-label-dark for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="nightIcon" viewBox="0 0 100 100" style="enable-background='new 0 0 100 100'"><title>Dark Mode</title><path d="M96.76 66.458c-.853-.852-2.15-1.064-3.23-.534-6.063 2.991-12.858 4.571-19.655 4.571C62.022 70.495 50.88 65.88 42.5 57.5 29.043 44.043 25.658 23.536 34.076 6.47c.532-1.08.318-2.379-.534-3.23-.851-.852-2.15-1.064-3.23-.534-4.918 2.427-9.375 5.619-13.246 9.491-9.447 9.447-14.65 22.008-14.65 35.369.0 13.36 5.203 25.921 14.65 35.368s22.008 14.65 35.368 14.65c13.361.0 25.921-5.203 35.369-14.65 3.872-3.871 7.064-8.328 9.491-13.246C97.826 68.608 97.611 67.309 96.76 66.458z"/></svg></label></div></header><article><h1>Lecture 5 - Query Optimization</h1><p class=meta>Last updated
Mar 17, 2023</p><ul class=tags></ul><aside class=mainTOC><details open><summary>Table of Contents</summary><nav id=TableOfContents><ol><li><a href=#evaluating-a-given-query>Evaluating a given query</a></li><li><a href=#equivalence-rules>Equivalence Rules</a></li><li><a href=#cost-based-optimization>Cost-Based Optimization</a></li><li><a href=#heuristics-in-optimization>Heuristics in Optimization</a><ol><li><a href=#concept-of-memoization>Concept of memoization</a></li><li><a href=#implemented-as-plan-caching>Implemented as plan caching</a></li></ol></li><li><a href=#materialized-views>Materialized Views</a><ol><li><a href=#query-optimization-and-materialized-views>Query Optimization and Materialized Views</a></li><li><a href=#materialized-view-creation>Materialized View Creation</a></li></ol></li><li><a href=#statistical-information-for-cost-estimation>Statistical Information for Cost Estimation</a></li></ol></nav></details></aside><p><a href=https://diogorainhalopes.github.io/adsi/slides/adsi-05-optimization.pdf rel=noopener>Slides</a></p><a href=#query-optimization><h1 id=query-optimization><span class=hanchor arialabel=Anchor># </span>Query Optimization</h1></a><a href=#evaluating-a-given-query><h2 id=evaluating-a-given-query><span class=hanchor arialabel=Anchor># </span>Evaluating a given query</h2></a><p><img src=https://diogorainhalopes.github.io/adsi//assets/rel_alg_1.png width=auto alt></p><p>Query optimization is finding the optimal execution plan</p><ul><li><p>From a) to b) we change the plan because we only join the rows we want, which translates in a better performance becasue has smaller intermediate results</p></li><li><p>Pushed down selection of rows from a) to b)</p></li><li><p>We can also push down selection of columns</p></li></ul><a href=#equivalence-rules><h2 id=equivalence-rules><span class=hanchor arialabel=Anchor># </span>Equivalence Rules</h2></a><p><img src=https://diogorainhalopes.github.io/adsi//assets/equiv_r.png width=auto alt></p><p>Associative Rules in Joins can be useful to maintain order or use some index</p><p>See examples on slides</p><p>Performing the selection as early as possible reduces the size of
the relation to be joined.
Performing the projection as early as possible reduces the size of
the relation to be joined.</p><a href=#cost-based-optimization><h2 id=cost-based-optimization><span class=hanchor arialabel=Anchor># </span>Cost-Based Optimization</h2></a><p>Now consider finding the best join order for:
(r 1 ⨝ r 2 ⨝ r 3 ⨝ r 4 ⨝ r 5)</p><ul><li>There are 12 different join orders for r 1 ⨝ r 2 ⨝ r 3 and another 12 orders for (&mldr;) ⨝ r 4 ⨝ r 5
Should we consider 12x12 joins orders?</li><li>No. Only 12+12. We choose the best order for r 1 ⨝ r 2 ⨝ r 3 and the best order for (&mldr;) ⨝ r 4 ⨝ r 5 independently.</li><li>When an optimization problem can be solved by optimizing sub problems independently, we can use dynamic programming</li></ul><a href=#heuristics-in-optimization><h2 id=heuristics-in-optimization><span class=hanchor arialabel=Anchor># </span>Heuristics in Optimization</h2></a><ul><li>E.g. in left deep join trees, the right hand side input for each join is always a relation, not the result of an intermediate join.</li><li>Fewer join orders to consider.</li></ul><p><img src=https://diogorainhalopes.github.io/adsi//assets/left_tree.png width=auto alt></p><a href=#concept-of-memoization><h3 id=concept-of-memoization><span class=hanchor arialabel=Anchor># </span>Concept of memoization</h3></a><ul><li>Store the best plan for a subexpression the first time it is optimized, and reuse it on repeated optimization calls on same subexpression</li></ul><a href=#implemented-as-plan-caching><h3 id=implemented-as-plan-caching><span class=hanchor arialabel=Anchor># </span>Implemented as plan caching</h3></a><ul><li>Reuse previously computed plan if query is resubmitted</li><li>Even with different constants in query</li><li>Applies to the exact same query</li></ul><a href=#materialized-views><h2 id=materialized-views><span class=hanchor arialabel=Anchor># </span>Materialized Views</h2></a><ul><li>A materialized view is a view whose contents are computed and stored.</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>create</span><span class=w> </span><span class=k>view</span><span class=w> </span><span class=n>my_students</span><span class=w> </span><span class=n>ID</span><span class=p>,</span><span class=w> </span><span class=n>name</span><span class=w> </span><span class=k>as</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>select</span><span class=w> </span><span class=n>student</span><span class=p>.</span><span class=n>ID</span><span class=p>,</span><span class=w> </span><span class=n>student</span><span class=p>.</span><span class=n>name</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>from</span><span class=w> </span><span class=n>student</span><span class=w> </span><span class=p>,</span><span class=w> </span><span class=n>takes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>where</span><span class=w> </span><span class=n>student</span><span class=p>.</span><span class=n>ID</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>takes</span><span class=p>.</span><span class=n>ID</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>and</span><span class=w> </span><span class=n>takes</span><span class=p>.</span><span class=n>course_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;CS 347&#39;</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ul><li>Materializing the above view would be very useful if the list of students is required frequently</li></ul><a href=#query-optimization-and-materialized-views><h3 id=query-optimization-and-materialized-views><span class=hanchor arialabel=Anchor># </span>Query Optimization and Materialized Views</h3></a><p><strong>Rewriting queries to use materialized views:</strong></p><ul><li>A materialized view v r ⨝ s is available</li><li>A user submits a query r ⨝ s ⨝ t</li><li>We can rewrite the query as v ⨝ t</li></ul><p>Whether to do so depends on cost estimates for the two options
The system knows which materialized views exist, so it can use them to optimize the query</p><p><strong>Replacing a use of a materialized view:</strong></p><ul><li>A materialized view v r ⨝ s is available</li><li>User submits a query (select)(A =10)(v) but the view has no index on A</li><li>Suppose r has an index on A , and s has an index on the common attribute</li><li>Then the best plan may be to replace v by r ⨝ s, which can lead to the query plan (select)(A =10) r ⨝ s</li></ul><p>Query optimizer should consider all above options and choose the best overall plan</p><a href=#materialized-view-creation><h3 id=materialized-view-creation><span class=hanchor arialabel=Anchor># </span>Materialized View Creation</h3></a><ul><li>Materialized view creation : &ldquo;W hat is the best set of views to materialize?&rdquo;</li><li>Index creation :&ldquo;What is the best set of indices to
closely related, but simpler</li><li>Materialized view creation and index creation based on typical system workload (queries and</li><li>Typical goal: minimize time to execute workload , subject to constraints on space and time taken for some critical queries/updates</li><li>One of the steps in database tuning (more on tuning in next lectures)</li><li>Commercial database systems provide tools (called " tuning assistants&rdquo; or &ldquo;wizards&rdquo;) to help the database administrator choose what indices and materialized views to create.</li></ul><a href=#statistical-information-for-cost-estimation><h2 id=statistical-information-for-cost-estimation><span class=hanchor arialabel=Anchor># </span>Statistical Information for Cost Estimation</h2></a><p>Important for:</p><ul><li>Can tell how many records to expect</li><li>Can tell performance costs/time</li><li>Selection size estimation</li></ul><p><img src=https://diogorainhalopes.github.io/adsi//assets/select_s_est.png width=auto alt></p><p><a href=/adsi/Lectures/Lecture-4-Query-Processing/ rel=noopener class=internal-link data-src=/adsi/Lectures/Lecture-4-Query-Processing/>Lecture 4 Query Processing</a> |
<a href=/adsi/Lectures/Lecture-6-Transactions-and-concurrency/ rel=noopener class=internal-link data-src=/adsi/Lectures/Lecture-6-Transactions-and-concurrency/>Lecture 6 Transactions and concurrency</a></p></article><hr><div class=page-end id=footer><div class=backlinks-container><h3>Backlinks</h3><ul class=backlinks><li><a href=/adsi/Lectures/Index-Lecture-Notes/ data-ctx="Lecture 5 Query Optimization" data-src=/Lectures/Index-Lecture-Notes class=internal-link>Index Lecture Notes</a></li><li><a href=/adsi/Lectures/Lecture-4-Query-Processing/ data-ctx="Lecture 5 Query Optimization" data-src=/Lectures/Lecture-4-Query-Processing class=internal-link>Lecture 4 - Query Processing</a></li><li><a href=/adsi/Lectures/Lecture-6-Transactions-and-concurrency/ data-ctx="Lecture 5 Query Optimization" data-src=/Lectures/Lecture-6-Transactions-and-concurrency class=internal-link>Lecture 6 - Transactions and concurrency</a></li></ul></div><div><script async src=https://cdn.jsdelivr.net/npm/d3@6.7.0/dist/d3.min.js integrity="sha256-+7jaYCp29O1JusNWHaYtgUn6EhuP0VaFuswhNV06MyI=" crossorigin=anonymous></script><h3>Interactive Graph</h3><div id=graph-container></div><style>:root{--g-node:var(--secondary);--g-node-active:var(--primary);--g-node-inactive:var(--visited);--g-link:var(--outlinegray);--g-link-active:#5a7282}</style><script src=https://diogorainhalopes.github.io/adsi/js/graph.6579af7b10c818dbd2ca038702db0224.js></script></div></div><div id=contact_buttons><footer><p>Made by Diogo Lopes using <a href=https://github.com/jackyzha0/quartz>Quartz</a>, © 2023</p><ul><li><a href=https://diogorainhalopes.github.io/adsi/>Home</a></li><li><a href=https://github.com/diogorainhalopes>GitHub</a></li></ul></footer></div></div></body></html>